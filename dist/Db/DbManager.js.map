{"version":3,"file":"DbManager.js","sourceRoot":"","sources":["../../src/Db/DbManager.ts"],"names":[],"mappings":";;AAEA;;;;GAIG;AACH;IAQE,YAAsB,MAAc,EAAY,MAAmB;QAA7C,WAAM,GAAN,MAAM,CAAQ;QAAY,WAAM,GAAN,MAAM,CAAa;QAJ3D,mBAAc,GAAY,KAAK,CAAC;QAKtC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC,SAAS,CAAC;QAC/B,IAAI,CAAC,oBAAoB,GAAG,EAAE,CAAC;QAC/B,IAAI,CAAC,UAAU,EAAE,CAAC;IACpB,CAAC;IAED;;OAEG;IACK,UAAU;QAChB,MAAM,GAAG,GAAqB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAC5D,GAAG,CAAC,eAAe,GAAG,IAAI,CAAC,UAAU,CAAC;QACtC,GAAG,CAAC,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC;IACvC,CAAC;IAEO,gBAAgB,CAAC,QAAmC;QAC1D,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IAC3C,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,CAAM;QAC5B,IAAI,CAAC,EAAE,GAAI,CAAC,CAAC,MAAM,CAAC,MAAsB,CAAC;QAC3C,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC,CAAC,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;IACrE,CAAC;IAED;;OAEG;IACK,UAAU,CAAC,CAAM;QACvB,IAAI,CAAC,EAAE,GAAG,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC;QAC1B,IAAI,MAAgC,CAAC;QACrC,IAAI,KAAgB,CAAC;QAErB,GAAG,CAAC,CAAC,MAAM,EAAE,IAAI,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;YAC7B,EAAE,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;gBACnC,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;gBACxB,MAAM,GAAG,EAAE,OAAO,EAAE,KAAK,CAAC,gBAAgB,EAAE,CAAC;gBAC7C,IAAI,QAAwB,CAAC;gBAC7B,QAAQ,GAAG,IAAI,CAAC,EAAE,CAAC,iBAAiB,CAAC,KAAK,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC;gBAC9D,QAAQ,CAAC,WAAW,CAAC,KAAK,CAAC,gBAAgB,EAAE,KAAK,CAAC,gBAAgB,CAAC,CAAC;YACvE,CAAC;QACH,CAAC;IACH,CAAC;IAEM,OAAO;QACZ,IAAI,CAAC,EAAE,CAAC,KAAK,EAAE,CAAC;QAChB,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACxC,IAAI,CAAC,UAAU,EAAE,CAAC;IACpB,CAAC;CACF;AA3DD,8BA2DC","sourcesContent":["import { TableInfo } from './Tables/TableInfo';\n\n/**\n * @class DbManager\n * @description Initializes IndexedDB instance, and creates tables\n * @author carathorys\n */\nexport class DbManager {\n\n  public db: IDBDatabase;\n\n  private hasInitialized: boolean = false;\n  private dbOpenedCallbackList: Array<(db: IDBDatabase) => void>;\n  private IndxDb: IDBFactory;\n\n  constructor(protected dbName: string, protected tInfos: TableInfo[]) {\n    this.IndxDb = window.indexedDB;\n    this.dbOpenedCallbackList = [];\n    this.OpenInitDB();\n  }\n\n  /**\n   * @description Opens and initializes IndexedDB, and updates it if it's necessary\n   */\n  private OpenInitDB() {\n    const req: IDBOpenDBRequest = this.IndxDb.open(this.dbName);\n    req.onupgradeneeded = this._addTables;\n    req.onsuccess = this._databaseOpened;\n  }\n\n  private OnDatabaseOpened(callback: (db: IDBDatabase) => void) {\n    this.dbOpenedCallbackList.push(callback);\n  }\n\n  /**\n   * @param e IDBRequest 'onsuccess' event\n   */\n  private _databaseOpened(e: any) {\n    this.db = (e.target.result as IDBDatabase);\n    this.dbOpenedCallbackList.forEach((callback) => callback(this.db));\n  }\n\n  /**\n   * @param e\n   */\n  private _addTables(e: any) {\n    this.db = e.target.result;\n    let params: IDBObjectStoreParameters;\n    let tInfo: TableInfo;\n\n    for (const it in this.tInfos) {\n      if (this.tInfos.hasOwnProperty(it)) {\n        tInfo = this.tInfos[it];\n        params = { keyPath: tInfo.PrimaryFieldName };\n        let tblLocal: IDBObjectStore;\n        tblLocal = this.db.createObjectStore(tInfo.TableName, params);\n        tblLocal.createIndex(tInfo.PrimaryIndexName, tInfo.PrimaryFieldName);\n      }\n    }\n  }\n\n  public ResetDB() {\n    this.db.close();\n    this.IndxDb.deleteDatabase(this.dbName);\n    this.OpenInitDB();\n  }\n}\n"]}